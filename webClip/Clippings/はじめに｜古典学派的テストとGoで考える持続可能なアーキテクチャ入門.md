---
title: はじめに｜古典学派的テストとGoで考える持続可能なアーキテクチャ入門
source: https://zenn.dev/jy8752/books/73769005e6afa9/viewer/chapter1
author:
  - "[[Zenn]]"
published: 
created: 2025-05-06
description: 
tags:
  - 1
  - Go
  - QA
  - 思想系
read: false
---
## この書籍について

現代の開発現場では単体テストを書くこと、クリーンアーキテクチャのようなアーキテクチャを採用することが当たり前になってきたように感じます。複雑なビジネスロジックをテストするには複雑な依存関係を解決する必要があることが多く、その場合にモックを使用したテストは非常に便利です。そして、抽象に依存させることでドメインを分離させるクリーンアーキテクチャはインターフェースを必要とするため、モックを使用したテストとも相性がいいように感じます。

しかし、 [単体テストの考え方/使い方](https://www.amazon.co.jp/%E5%8D%98%E4%BD%93%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9-%E4%BD%BF%E3%81%84%E6%96%B9-Vladimir-Khorikov/dp/4839981728) ではモックを極力使用しない **古典学派** と逆に全ての依存をモックにする **ロンドン学派** では **古典学派によるテストを推奨** しています。

本書籍では、「単体テストの考え方/使い方」の内容に基づき **持続可能な開発** をするためのアーキテクチャを簡単なAPIを作成する過程で再考していきたいと思います。使用する言語はGoになりますがGoがわからなくてもテストやアーキテクチャに関する考え方は理解できる内容のはずです。また、書籍「単体テストの考え方/使い方」の内容を全面的に扱いますが読んでいなくてもわかるような内容にしましたが、読んでいた方が理解度は上がると思います。

## 作成するAPI

今回はガチャのシュミレーションを実行するAPIを作成します。指定したガチャを抽選して抽選したアイテムをレスポンスとして取得するようなAPIを想定しています。

- エンドポイント `gacha/:gachaId/draw`
- パラメーター 抽選するガチャのID。
- HTTPメソッド POST
- レスポンス例

```
% curl -XPOST localhost:8080/gacha/1/draw | jq
{
  "id": 2,
  "name": "item2",
  "rarity": "N"
}
```

## DB設計

今回はDBにMySQLを使用する想定です。

![](https://storage.googleapis.com/zenn-user-upload/c32a127851de-20231104.png)

## アーキテクチャ設計

詳しくは書籍の中で解説いたしますがベースは **ヘキサゴナルアーキテクチャ** です。ただし、どのアーキテクチャかは重要ではなく **ドメインを何にも依存させない** 作りにするのにヘキサゴナルアーキテクチャが1番理想的でした。

![](https://storage.googleapis.com/zenn-user-upload/adb72f6088b3-20231104.png)

## 使用する技術

- Go go version go1.20.6 darwin/arm64
- [wire](https://github.com/google/wire) 依存性の解決 v0.5.0
- [sqlboiler](https://github.com/volatiletech/sqlboiler) ORM v4.15.0
- [golang-migtate](https://github.com/golang-migrate/migrate) マイグレーション v4.16.2
- [Taskfile](https://taskfile.dev/ja-JP/) タスクランナー Task version: 3.30.1
- dotenv + direnv 環境変数の管理
- [testify](https://github.com/stretchr/testify) アサーションに v1.8.4
- [dockertest](https://github.com/ory/dockertest) 結合テスト用にDB準備 v3.10.0
- [gomock](https://github.com/uber-go/mock) モック v0.3.0
- [goldie](https://github.com/sebdah/goldie) ゴールデンテスト v2.5.3
- [echo](https://github.com/labstack/echo) v4.11.2

## 書籍の構成

2-5章でアプリケーションで使用するDBやタスクの準備を行います。アプリケーションの作成から読みたい場合は第6章くらいまで読み飛ばしてください。

### 第２章 DBの準備

Dockerを使用してMySQLコンテナを起動します。また、秘匿情報の管理にdotenv+direnvの構成を採用します。

### 第3章　タスクランナー(Taskfile)を導入する

タスクランナーであるTaskfileを導入してDockerコマンドなどをタスク化します。

### 第4章 マイグレーション

DBにガチャデータを準備するためにマイグレーションファイルを作成します。

### 第5章 sqlboilerを使用したコードの自動生成

GoのORMであるsqlboilerを使用してDBにクエリを発行するためのコードを自動生成します。

### 第6章 なぜ古典学派のテストを書くのか？

この章ではアプリケーションを実装していく前に古典学派のテストとロンドン学派のテストについて比較し、なぜ古典学派のテストを書くのかを説明します。

### 第7章 なぜクリーンアーキテクチャを採用しないのか？

本書籍で作成するアプリケーションではクリーンアーキテクチャを採用していません。この章ではなぜクリーンアーキテクチャを採用しないのかについて説明します。

### 第8章 ガチャ抽選のビジネスロジックを抽出する

この章からはGoのプロジェクトを作成し、ガチャの抽選ロジックを実装していきます。一旦controllerに実装した一連の処理をリファクタリングしdomain層にビジネスロジックを切り出します。

### 第9章 ドメイン層の単体テスト

前章で抽出したドメイン層の単体テストを作成します。また、単体テストを書くにあたってのポイントや注意点についても説明します。

### 第10章 DB処理を抽出する

この章ではcontrollerからDB処理を抽出し、Repositoryを作成します。

### 第11章　controllerの結合テスト

この章では作成したcontrollerの結合テストを作成していきます。テスト用のDBはdockertestおよびgo-migrateを使用して準備します。また、Go製のモックライブラリであるgomockを使用してモックを使ったテストを作成します。

### 第12章 管理下にないプロセス外依存処理を追加しテストする

この章ではcontrollerに外部APIとして決済APIの呼び出しを追加してモックとスタブの違いに触れながらテストを修正していきます。

### 第13章 APIハンドラーの登録

外部からAPIとして呼び出しができるようにAPIハンドラーの登録を行います。

### 第14章 ゴールデンファイルテストを使用したE2Eテスト

APIハンドラーのテストをE2Eテストとして作成します。作成するテストはゴールデンファイルテストとして作成します。

### 第15章 依存関係の解決

依存関係の解決をGo製のライブラリであるwireを使用して作成します。

### 第16章 テストを実行単位でグループ分けする

質の良いテストの性質について解説します。また、実行するテストをGoのビルドタグを使用してグループ分けし,テストの種別ごとに実行できるようにします。